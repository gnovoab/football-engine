<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Football Simulator</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap");

        :root {
            --bg: #0a0f1c; --bg-2: #0d1a2f; --surface: #111b2d; --surface-2: #0f1726;
            --line: rgba(255,255,255,0.08); --text: #f1f5f9; --muted: rgba(226,232,240,0.66);
            --accent: #37d7d0; --accent-2: #ff9c66; --good: #27d17d; --warn: #f6c343;
            --bad: #ff6b6b; --shadow: 0 18px 40px rgba(4, 10, 24, 0.55);
        }
        :root.light {
            --bg: #f8fafc; --bg-2: #f1f5f9; --surface: #ffffff; --surface-2: #fdfdfd;
            --line: rgba(0,0,0,0.1); --text: #0f172a; --muted: #64748b; --shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; }
        body { margin: 0; min-height: 100vh; color: var(--text); font-family: "Space Grotesk", sans-serif; background: linear-gradient(160deg, var(--bg), var(--bg-2)); transition: 0.3s; }

        header { padding: 16px 20px; border-bottom: 1px solid var(--line); display: flex; align-items: center; gap: 16px; position: sticky; top: 0; background: var(--surface); backdrop-filter: blur(10px); z-index: 5; }
        .tabs { display: flex; gap: 8px; }
        .tab { border: 1px solid var(--line); background: var(--surface-2); color: var(--text); padding: 8px 16px; border-radius: 999px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .tab.active { border-color: var(--accent); background: var(--accent); color: #0a0f1c; font-weight: 600; }

        .winning { color: var(--accent); font-weight: 800; }
        @keyframes goal-blink { 0% { background: transparent; } 50% { background: var(--good); color: white; } 100% { background: transparent; } }
        .blink-goal { animation: goal-blink 0.8s ease 3; }

        main { padding: 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 16px; max-width: 1600px; margin: 0 auto; }
        .panel { background: var(--surface); border: 1px solid var(--line); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); }
        .panel-head { padding: 14px 16px; border-bottom: 1px solid var(--line); font-weight: 600; font-size: 13px; color: var(--muted); text-transform: uppercase; }

        .summary-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; padding: 12px; }
        .summary-item { background: var(--surface-2); border-radius: 12px; padding: 12px; border: 1px solid var(--line); }
        .summary-item .label { font-size: 10px; color: var(--muted); text-transform: uppercase; }
        .summary-item .value { font-size: 13px; font-weight: 600; margin-top: 4px; font-family: 'JetBrains Mono', monospace; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 14px; border-bottom: 1px solid var(--line); font-size: 13px; text-align: left; }
        tr.clickable:hover { background: rgba(255,255,255,0.03); cursor: pointer; }

        .feed { max-height: 500px; overflow-y: auto; padding: 14px; font-family: "JetBrains Mono", monospace; font-size: 11px; }
        .feed-line { padding: 8px 0; border-bottom: 1px dashed var(--line); line-height: 1.4; }
        .feed-line.goal { color: var(--good); font-weight: bold; background: rgba(39, 209, 125, 0.05); border-left: 3px solid var(--good); padding-left: 8px; }
        .feed-line.card { color: var(--warn); border-left: 3px solid var(--warn); padding-left: 8px; }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 10; backdrop-filter: blur(5px); padding: 20px; }
        .modal-backdrop.open { display: flex; }
        .modal { width: min(850px, 100%); background: var(--surface); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { display: grid; grid-template-columns: 1fr 1fr; overflow-y: auto; }
        .modal-pane { padding: 24px; border-right: 1px solid var(--line); }
        .modal-pane:last-child { border-right: none; background: var(--surface-2); }

        .stats-label { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
        .bar-track { height: 12px; background: var(--line); border-radius: 6px; display: flex; overflow: hidden; margin-bottom: 16px; }
        .bar-home { background: var(--accent); transition: width 0.4s; width: 50%; }
        .bar-away { background: var(--accent-2); transition: width 0.4s; width: 50%; border-left: 2px solid var(--surface); }

        .btn { border: 1px solid var(--line); background: var(--surface-2); color: var(--text); padding: 8px 14px; border-radius: 10px; cursor: pointer; font-size: 12px; }

        @media (max-width: 850px) { .modal-body { grid-template-columns: 1fr; } .modal-pane { border-right: none; border-bottom: 1px solid var(--line); } }
    </style>
</head>
<body>

<header>
    <div class="brand"><div class="brand-title">Football Simulator</div><div class="brand-sub">Realtime Engine</div></div>
    <div class="tabs" id="tabs">
        <button class="tab active" data-league="PREMIER_LEAGUE">Premier League</button>
        <button class="tab" data-league="SERIE_A">Serie A</button>
        <button class="tab" data-league="LA_LIGA">La Liga</button>
    </div>
    <div class="spacer"></div>
    <button id="themeToggle" class="btn">ðŸŒ“ Theme</button>
    <div id="connPill" class="pill">disconnected</div>
</header>

<main>
    <section class="panel" style="grid-column: 1 / -1;">
        <div class="summary-row">
            <div class="summary-item"><div class="label">League</div><div class="value" id="sumLg">â€”</div></div>
            <div class="summary-item"><div class="label">Fixture</div><div class="value" id="sumFx">â€”</div></div>
            <div class="summary-item"><div class="label">Round</div><div class="value" id="sumRd">â€”</div></div>
            <div class="summary-item"><div class="label">Matches</div><div class="value" id="sumMt">â€”</div></div>
            <div class="summary-item"><div class="label">Status</div><div class="value" id="sumSt">â€”</div></div>
        </div>
    </section>

    <section class="panel">
        <div class="panel-head">Live Scores</div>
        <table>
            <thead><tr><th>Match</th><th>Score</th><th>Phase</th><th>Live Clock</th></tr></thead>
            <tbody id="matchesBody"></tbody>
        </table>
    </section>

    <aside class="panel"><div class="panel-head">Global Event Feed</div><div class="feed" id="mainFeed"></div></aside>
</main>

<div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle" style="margin:0; font-size: 16px;">Match View</h3>
            <button class="btn" onclick="closeModal()">Close</button>
        </div>
        <div class="modal-body">
            <div class="modal-pane">
                <div id="mScore" style="font-size: 42px; font-weight: 800; text-align: center; margin-bottom: 24px;">0 - 0</div>

                <div class="stats-container">
                    <div class="stats-label"><span>Win Probability</span></div>
                    <div class="bar-track" style="height: 20px; margin-bottom: 4px;">
                        <div id="probH" class="bar-home" style="display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #0a0f1c;">50%</div>
                        <div id="probA" class="bar-away" style="display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #0a0f1c;">50%</div>
                    </div>
                    <div id="predictionText" style="font-size: 10px; text-align: center; color: var(--muted); margin-bottom: 20px; font-style: italic;">Calculating forecast...</div>

                    <div class="stats-label"><span>Shots</span><span id="lShots">0/0</span></div>
                    <div class="bar-track"><div id="bShotsH" class="bar-home"></div><div id="bShotsA" class="bar-away"></div></div>

                    <div class="stats-label"><span>Corners</span><span id="lCorners">0/0</span></div>
                    <div class="bar-track"><div id="bCornersH" class="bar-home"></div><div id="bCornersA" class="bar-away"></div></div>
                </div>

                <div style="display: flex; justify-content: space-around; font-size: 13px; border-top: 1px solid var(--line); padding-top: 15px;">
                    <div>Phase: <b id="mPhase">-</b></div>
                    <div>Clock: <b id="mTime">00:00</b></div>
                </div>
            </div>
            <div class="modal-pane"><div class="stats-label">Timeline</div><div class="feed" id="mFeed" style="padding: 0;"></div></div>
        </div>
    </div>
</div>

<script>
    (() => {
        let league = "PREMIER_LEAGUE";
        let fixtureWs = null, matchWs = null, selectedId = null;
        const matchIndex = new Map();
        const leagueFeeds = new Map();

        const matchClocks = new Map();
        let timerInterval = null;

        const mainFeed = document.getElementById("mainFeed");
        const matchesBody = document.getElementById("matchesBody");

        document.getElementById("themeToggle").onclick = () => {
            const isL = document.documentElement.classList.toggle('light');
            localStorage.setItem('theme', isL ? 'light' : 'dark');
        };
        if(localStorage.getItem('theme') === 'light') document.documentElement.classList.add('light');

        const formatTime = (s) => {
            const mins = Math.floor(s / 60).toString().padStart(2, '0');
            const secs = (s % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        };

        const wsUrl = (path) => (location.protocol === "https:" ? "wss:" : "ws:") + "//" + location.host + path;

        function startGlobalTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                matchClocks.forEach((data, id) => {
                    if (data.phase === "FIRST_HALF" || data.phase === "SECOND_HALF") {
                        data.seconds += 1;
                        const tiEl = document.getElementById(`ti-${id}`);
                        if (tiEl) tiEl.textContent = formatTime(data.seconds);
                        if (selectedId === id) document.getElementById("mTime").textContent = formatTime(data.seconds);
                    }
                });
            }, 1000);
        }

        async function connect() {
            if (fixtureWs) fixtureWs.close();
            document.getElementById("connPill").textContent = "connecting...";
            mainFeed.innerHTML = leagueFeeds.get(league) || "";
            matchClocks.clear();

            try {
                const res = await fetch(`/api/runners/${league}/running-fixture`);
                const rf = await res.json();
                document.getElementById("sumLg").textContent = league.replace('_',' ');
                document.getElementById("sumFx").textContent = rf.fixtureId || "â€”";
                document.getElementById("sumRd").textContent = rf.round || "â€”";
                document.getElementById("sumMt").textContent = rf.matches ? rf.matches.length : "0";
                document.getElementById("sumSt").textContent = rf.status;

                if (rf.status === "RUNNING") {
                    renderMatches(rf.matches);
                    startGlobalTimer();
                    fixtureWs = new WebSocket(wsUrl(rf.ws.fixture));
                    fixtureWs.onopen = () => document.getElementById("connPill").textContent = "connected";
                    fixtureWs.onmessage = (m) => handleMsg(JSON.parse(m.data));
                }
            } catch (e) { console.error(e); }
        }

        function renderMatches(matches) {
            matchesBody.innerHTML = "";
            matches.forEach(m => {
                matchIndex.set(m.matchId, m);
                matchClocks.set(m.matchId, { seconds: 0, phase: "WAITING" });
                const tr = document.createElement("tr");
                tr.id = `row-${m.matchId}`;
                tr.className = "clickable";
                tr.innerHTML = `<td><b class="h">${m.homeTeam}</b> vs <b class="a">${m.awayTeam}</b></td><td id="sc-${m.matchId}" style="font-weight:bold;">0-0</td><td id="ph-${m.matchId}">-</td><td id="ti-${m.matchId}">00:00</td>`;
                tr.onclick = () => openModal(m.matchId);
                matchesBody.appendChild(tr);
            });
        }

        function handleMsg(ev) {
            const m = matchIndex.get(ev.matchId);
            if (!m) return;

            if (ev.type === "MATCH_SNAPSHOT" || ev.type === "GOAL" || ev.type.includes("HALF") || ev.type.includes("TIME")) {
                const s = ev.match;
                matchClocks.set(ev.matchId, { seconds: s.second, phase: s.phase });

                const scEl = document.getElementById(`sc-${ev.matchId}`);
                if (scEl) {
                    if (scEl.textContent !== "0-0" && scEl.textContent !== `${s.homeScore}-${s.awayScore}`) {
                        scEl.classList.add("blink-goal"); setTimeout(() => scEl.classList.remove("blink-goal"), 2000);
                    }
                    scEl.textContent = `${s.homeScore}-${s.awayScore}`;
                    document.getElementById(`ph-${ev.matchId}`).textContent = s.phase;
                    document.getElementById(`ti-${ev.matchId}`).textContent = formatTime(s.second);

                    const tr = document.getElementById(`row-${ev.matchId}`);
                    tr.querySelector(".h").classList.toggle("winning", s.homeScore > s.awayScore);
                    tr.querySelector(".a").classList.toggle("winning", s.awayScore > s.homeScore);
                }
                if (selectedId === ev.matchId) updateModal(ev);
            }

            if (ev.type !== "MATCH_SNAPSHOT") {
                const side = ev.data?.side ? `(${ev.data.side === 'HOME' ? m.homeTeam : m.awayTeam}) ` : "";
                const line = `[${league}] ${Math.floor(ev.match.second/60)}' ${m.homeTeam} vs ${m.awayTeam} Â· ${side}${ev.type}`;
                const div = document.createElement("div");
                div.className = "feed-line" + (ev.type === 'GOAL' ? ' goal' : (ev.type.includes('CARD') ? ' card' : ''));
                div.textContent = line;
                div.setAttribute('data-mid', ev.matchId);
                div.setAttribute('data-txt', `${Math.floor(ev.match.second/60)}' Â· ${side}${ev.type}`);
                mainFeed.prepend(div);
                leagueFeeds.set(league, mainFeed.innerHTML);
                if (selectedId === ev.matchId) {
                    const md = div.cloneNode(true); md.textContent = div.getAttribute('data-txt');
                    document.getElementById("mFeed").prepend(md);
                }
            }
        }

        function openModal(id) {
            selectedId = id; const m = matchIndex.get(id);
            document.getElementById("modalTitle").textContent = `${m.homeTeam} vs ${m.awayTeam}`;
            const mFeed = document.getElementById("mFeed"); mFeed.innerHTML = "";
            const clock = matchClocks.get(id);
            if (clock) document.getElementById("mTime").textContent = formatTime(clock.seconds);

            mainFeed.querySelectorAll('.feed-line').forEach(evt => {
                if(evt.getAttribute('data-mid') === id) {
                    const d = document.createElement("div"); d.className = evt.className;
                    d.textContent = evt.getAttribute('data-txt'); mFeed.appendChild(d);
                }
            });
            document.getElementById("modalBackdrop").classList.add("open");
            if (matchWs) matchWs.close();
            matchWs = new WebSocket(wsUrl(m.ws.match));
            matchWs.onmessage = (msg) => handleMsg(JSON.parse(msg.data));
        }

        function updateModal(ev) {
            const s = ev.match;
            document.getElementById("mScore").textContent = `${s.homeScore} - ${s.awayScore}`;
            document.getElementById("mPhase").textContent = s.phase;
            document.getElementById("mTime").textContent = formatTime(s.second);

            if (ev.data?.stats) {
                const st = ev.data.stats;
                const ub = (h, a, lId, hb, ab) => {
                    document.getElementById(lId).textContent = `${h}/${a}`;
                    const t = h + a; const hp = t === 0 ? 50 : (h/t*100);
                    document.getElementById(hb).style.width = hp + "%"; document.getElementById(ab).style.width = (100-hp) + "%";
                };
                ub(st.shotsHome, st.shotsAway, "lShots", "bShotsH", "bShotsA");
                ub(st.cornersHome, st.cornersAway, "lCorners", "bCornersH", "bCornersA");

                // Probability Engine
                const timeLeft = Math.max(0, 5400 - s.second);
                const homeAdv = (s.homeScore - s.awayScore) * 35;
                const shotAdv = (st.shotsHome - st.shotsAway) * 2.5;
                let hProb = 50 + homeAdv + shotAdv;
                if (timeLeft > 300) hProb = Math.min(96, Math.max(4, hProb));
                else { if (s.homeScore > s.awayScore) hProb = 99; else if (s.awayScore > s.homeScore) hProb = 1; else hProb = 50; }
                const aProb = 100 - hProb;
                document.getElementById("probH").style.width = hProb + "%";
                document.getElementById("probH").textContent = Math.round(hProb) + "%";
                document.getElementById("probA").style.width = aProb + "%";
                document.getElementById("probA").textContent = Math.round(aProb) + "%";

                let v = "Highly Competitive";
                if (hProb > 80) v = `${matchIndex.get(ev.matchId).homeTeam} dominant`;
                else if (aProb > 80) v = `${matchIndex.get(ev.matchId).awayTeam} dominant`;
                document.getElementById("predictionText").textContent = `Forecast: ${v}`;
            }
        }

        window.closeModal = () => { document.getElementById("modalBackdrop").classList.remove("open"); selectedId = null; if (matchWs) matchWs.close(); };
        document.getElementById("tabs").onclick = (e) => {
            const b = e.target.closest("button"); if (!b) return;
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            b.classList.add("active"); league = b.dataset.league; connect();
        };
        connect();
    })();
</script>
</body>
</html>